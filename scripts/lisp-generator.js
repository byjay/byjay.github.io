document.addEventListener('DOMContentLoaded', function() {
    // Tab Switching Logic
    const tabs = document.querySelectorAll('.category-list li');
    const forms = document.querySelectorAll('.gen-form');

    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            // Remove active class from all tabs and forms
            tabs.forEach(t => t.classList.remove('active'));
            forms.forEach(f => {
                f.style.display = 'none';
                f.classList.remove('active');
            });

            // Add active class to clicked tab
            tab.classList.add('active');

            // Show corresponding form
            const cat = tab.getAttribute('data-cat');
            const targetForm = document.getElementById(`form-${cat}`);
            if (targetForm) {
                targetForm.style.display = 'block';
                targetForm.classList.add('active');
            }
        });
    });

    // Generate Button Logic
    const generateBtn = document.getElementById('generate-btn');
    const codeOutput = document.getElementById('code-output');
    const downloadBtn = document.getElementById('download-btn');

    generateBtn.addEventListener('click', () => {
        const activeForm = document.querySelector('.gen-form.active');
        if (!activeForm) return;

        let lispCode = "";
        const formId = activeForm.id;

        if (formId === 'form-calc') {
            lispCode = generateCalcLisp();
        } else if (formId === 'form-text') {
            lispCode = generateTextLisp();
        }

        codeOutput.textContent = lispCode;
        downloadBtn.disabled = false;
    });

    // Download Button Logic
    downloadBtn.addEventListener('click', () => {
        const code = codeOutput.textContent;
        if (!code) return;

        const blob = new Blob([code], { type: 'text/plain' });
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'generated_routine.lsp';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
    });
});

function generateCalcLisp() {
    const func = document.getElementById('calc-func').value;
    const cmd = document.getElementById('calc-cmd').value || "TL";
    
    // Get selected objects
    const checkboxes = document.querySelectorAll('#form-calc input[type="checkbox"]:checked');
    const types = Array.from(checkboxes).map(cb => cb.value).join(",");

    let code = `;;; Generated by CAD Help Lisp Generator\n`;
    code += `;;; Command: ${cmd}\n`;
    code += `;;; Function: ${func}\n\n`;

    code += `(defun c:${cmd} (/ ss i ent len total)\n`;
    code += `  (setq total 0)\n`;
    
    if (func === 'total_len') {
        code += `  (prompt "\\nSelect objects to calculate total length: ")\n`;
        // Build filter list
        let filter = "";
        if (types) {
             filter = `'((0 . "${types}"))`; // Simplified filter for demo
        }
        
        code += `  (setq ss (ssget ${filter}))\n`;
        code += `  (if ss\n`;
        code += `    (progn\n`;
        code += `      (setq i 0)\n`;
        code += `      (repeat (sslength ss)\n`;
        code += `        (setq ent (ssname ss i))\n`;
        code += `        (command "_.lengthen" ent "")\n`;
        code += `        (setq len (getvar "PERIMETER"))\n`;
        code += `        (setq total (+ total len))\n`;
        code += `        (setq i (1+ i))\n`;
        code += `      )\n`;
        code += `      (alert (strcat "Total Length: " (rtos total 2 2)))\n`;
        code += `    )\n`;
        code += `    (prompt "\\nNo objects selected.")\n`;
        code += `  )\n`;
    } else if (func === 'count_obj') {
         code += `  (prompt "\\nSelect objects to count: ")\n`;
         code += `  (setq ss (ssget))\n`;
         code += `  (if ss\n`;
         code += `    (alert (strcat "Selected Objects: " (itoa (sslength ss))))\n`;
         code += `    (prompt "\\nNo objects selected.")\n`;
         code += `  )\n`;
    }

    code += `  (princ)\n`;
    code += `)\n`;

    return code;
}

function generateTextLisp() {
    const cmd = document.getElementById('text-cmd').value || "TNUM";
    const start = document.getElementById('text-start').value;
    const step = document.getElementById('text-step').value;

    let code = `;;; Generated by CAD Help Lisp Generator\n`;
    code += `;;; Command: ${cmd}\n\n`;
    code += `(defun c:${cmd} (/ pt)\n`;
    code += `  (setq num ${start})\n`;
    code += `  (while (setq pt (getpoint "\\nPick point for number: "))\n`;
    code += `    (command "_.text" pt "" "" (itoa num))\n`;
    code += `    (setq num (+ num ${step}))\n`;
    code += `  )\n`;
    code += `  (princ)\n`;
    code += `)\n`;
    
    return code;
}
